# .github/workflows/scrape_barrages.yml
# VERSION ULTRA-SIMPLIFIÃ‰E - N'utilise PAS requirements.txt

name: Scraping Barrages Maroc

on:
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Show current directory
        run: |
          echo "ğŸ“‚ Current directory:"
          pwd
          echo ""
          echo "ğŸ“‹ Files in current directory:"
          ls -la
          echo ""
          echo "ğŸ“‹ Files in scripts directory:"
          ls -la scripts/ || echo "âŒ scripts/ directory not found"
      
      - name: Install dependencies directly
        run: |
          echo "ğŸ”§ Installing Python packages..."
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml psycopg2-binary python-dotenv
          echo "âœ… Installation complete"
      
      - name: Verify psycopg2 installation
        run: |
          echo "ğŸ§ª Testing psycopg2..."
          python -c "import psycopg2; print('âœ… psycopg2 version:', psycopg2.__version__)"
      
      - name: Show Python environment
        run: |
          echo "ğŸ Python version:"
          python --version
          echo ""
          echo "ğŸ“¦ Installed packages:"
          pip list
      
      - name: Run scraping script
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          echo "ğŸš€ Starting scraper..."
          echo "ğŸ“‚ Looking for script in: scripts/scraper_barrages_maroc.py"
          
          if [ -f "scripts/scraper_barrages_maroc.py" ]; then
            echo "âœ… Script found!"
            python scripts/scraper_barrages_maroc.py
          else
            echo "âŒ Script NOT found at scripts/scraper_barrages_maroc.py"
            echo "ğŸ“‹ Available Python files:"
            find . -name "*.py" -type f
            exit 1
          fi
      
      - name: Upload results
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: barrages-data-${{ github.run_number }}
          path: barrages_data.json
          retention-days: 30
      
      - name: Show detailed error
        if: failure()
        run: |
          echo "âŒâŒâŒ WORKFLOW FAILED âŒâŒâŒ"
          echo ""
          echo "Please check:"
          echo "1. Script exists at: scripts/scraper_barrages_maroc.py"
          echo "2. DATABASE_URL secret is set correctly"
          echo "3. No typos in the script name"
