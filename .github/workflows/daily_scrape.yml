# .github/workflows/daily_scrape.yml
# VERSION ULTRA-ROBUSTE avec installation explicite

name: scrape-and-store

on:
  workflow_dispatch:
  schedule:
    - cron: '15 9 * * *'

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Upgrade pip and setuptools
        run: |
          python -m pip install --upgrade pip setuptools wheel
      
      - name: Install psycopg2-binary first (critical)
        run: |
          echo "Installing psycopg2-binary..."
          pip install psycopg2-binary==2.9.9
          python -c "import psycopg2; print('âœ… psycopg2 version:', psycopg2.__version__)"
      
      - name: Install other dependencies
        run: |
          pip install requests==2.31.0
          pip install beautifulsoup4==4.12.3
          pip install lxml==5.1.0
          pip install python-dotenv==1.0.1
      
      - name: Verify all imports
        run: |
          python -c "import psycopg2; print('âœ… psycopg2')"
          python -c "import requests; print('âœ… requests')"
          python -c "from bs4 import BeautifulSoup; print('âœ… beautifulsoup4')"
          python -c "from dotenv import load_dotenv; print('âœ… python-dotenv')"
      
      - name: Show installed packages
        run: pip list
      
      - name: Run scraping script
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
        run: |
          echo "ðŸš€ Starting scraper..."
          python scripts/scraper_barrages_maroc.py
      
      - name: Upload JSON artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: barrages-data-${{ github.run_number }}
          path: barrages_data.json
          retention-days: 90
